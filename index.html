import React, { useState, useEffect, useMemo, useRef } from 'react';
import { initializeApp, getApps } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, serverTimestamp, arrayUnion, getDoc, setDoc } from 'firebase/firestore';

// --- Ikonit ---
const Icons = {
  Plus: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
  Search: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" cy="21" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
  Trash: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
  X: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="18" x2="18" y2="6"/></svg>,
  Share: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8M16 6l-4-4-4 4M12 2v13"/></svg>,
  Edit: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
  Shield: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
  Check: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
  Loader: () => <svg className="animate-spin" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10" stroke="currentColor" strokeOpacity="0.25" strokeWidth="4"/><path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" strokeWidth="4" strokeLinecap="round"/></svg>,
  Download: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>,
  Upload: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>,
  Settings: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
  Camera: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>,
  Image: () => <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1" strokeLinecap="round" strokeLinejoin="round" className="opacity-10"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
};

const CATEGORIES = [
  { id: 'all', label: 'Kaikki', color: 'bg-slate-800' },
  { id: 'pääruoka', label: 'Pääruoka', color: 'bg-orange-500' },
  { id: 'jälkiruoka', label: 'Jälkiruoka', color: 'bg-pink-500' },
  { id: 'leivonta', label: 'Leivonta', color: 'bg-amber-600' },
  { id: 'aamiainen', label: 'Aamiainen', color: 'bg-yellow-500' },
  { id: 'kasvisruoka', label: 'Kasvisruoka', color: 'bg-green-600' },
  { id: 'juomat', label: 'Juomat', color: 'bg-blue-500' },
  { id: 'muut', label: 'Muut', color: 'bg-slate-500' }
];

const VALID_CATEGORY_IDS = CATEGORIES.map(c => c.id).filter(id => id !== 'all');
const apiKey = ""; 

export default function App() {
  const [user, setUser] = useState(null);
  const [db, setDb] = useState(null);
  const [adminConfig, setAdminConfig] = useState(null);
  const [branding, setBranding] = useState({ copyright: "Copyright 2026 Pekka Niemistö" });
  const [myRecipes, setMyRecipes] = useState([]);
  const [publicRecipes, setPublicRecipes] = useState([]);
  const [activeTab, setActiveTab] = useState('private'); 
  const [selectedFilter, setSelectedFilter] = useState('all');
  const [searchTerm, setSearchTerm] = useState('');
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [activeRecipe, setActiveRecipe] = useState(null);
  const [isEditing, setIsEditing] = useState(false);
  const [editForm, setEditForm] = useState(null);
  const [recipeToDelete, setRecipeToDelete] = useState(null);
  const [status, setStatus] = useState({ msg: "", type: "" });
  const [appReady, setAppReady] = useState(false);
  
  // Admin & Asetukset
  const [adminInput, setAdminInput] = useState("");
  const [brandingInput, setBrandingInput] = useState("");
  const [versionClickCount, setVersionClickCount] = useState(0);
  const [showAdminDetails, setShowAdminDetails] = useState(false);

  const appId = typeof __app_id !== 'undefined' ? __app_id : 'recipe-pro-master-v1';

  // --- REAKTIO: Tilaviestin automaattinen poistaminen ---
  useEffect(() => {
    if (status.msg) {
      const timer = setTimeout(() => {
        setStatus({ msg: "", type: "" });
      }, 3000);
      return () => clearTimeout(timer);
    }
  }, [status.msg]);

  // --- REAKTIO: Päivitetään aktiivinen resepti jos se muuttuu tietokannassa ---
  useEffect(() => {
    if (activeRecipe) {
      const source = activeTab === 'private' ? myRecipes : publicRecipes;
      const updated = source.find(r => r.id === activeRecipe.id);
      if (updated && JSON.stringify(updated) !== JSON.stringify(activeRecipe)) {
        setActiveRecipe(updated);
      }
    }
  }, [myRecipes, publicRecipes, activeRecipe, activeTab]);

  // --- FIREBASE INIT ---
  useEffect(() => {
    const initApp = async () => {
      try {
        const config = JSON.parse(__firebase_config);
        const firebaseApp = getApps().length === 0 ? initializeApp(config) : getApps()[0];
        const firestore = getFirestore(firebaseApp);
        const auth = getAuth(firebaseApp);
        setDb(firestore);

        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }

        // Admin config
        const adminRef = doc(firestore, 'artifacts', appId, 'public', 'data', 'settings', 'admin');
        onSnapshot(adminRef, (d) => { if (d.exists()) setAdminConfig(d.data()); });

        // BRANDING: Noudetaan copyright pilvestä (Rule 1 & 3)
        const brandingRef = doc(firestore, 'artifacts', appId, 'public', 'data', 'settings', 'branding');
        onSnapshot(brandingRef, (d) => { 
          if (d.exists()) {
            setBranding(d.data());
            setBrandingInput(d.data().copyright);
          }
        });

        onAuthStateChanged(auth, setUser);
        setAppReady(true);
      } catch (e) { console.error(e); setAppReady(true); }
    };
    initApp();
  }, []);

  // --- DATA SYNC ---
  useEffect(() => {
    if (!user || !db) return;
    const unsubPrivate = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'recipes'), (snap) => {
      setMyRecipes(snap.docs.map(d => ({ id: d.id, ...d.data(), isOwner: true })));
    });
    const unsubPublic = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'recipes'), (snap) => {
      setPublicRecipes(snap.docs.map(d => ({ id: d.id, ...d.data(), isOwner: d.data().ownerId === user.uid })));
    });
    return () => { unsubPrivate(); unsubPublic(); };
  }, [user, db]);

  const isAdmin = useMemo(() => {
    if (!user || !adminConfig) return false;
    return (adminConfig.uids || [adminConfig.uid]).includes(user.uid);
  }, [user, adminConfig]);

  const filteredRecipes = useMemo(() => {
    const base = activeTab === 'private' ? myRecipes : (activeTab === 'public' ? publicRecipes : []);
    return base.filter(r => {
      const catMatch = selectedFilter === 'all' || r.category?.toLowerCase() === selectedFilter.toLowerCase();
      const s = searchTerm.toLowerCase().trim();
      return catMatch && (!s || r.title?.toLowerCase().includes(s) || (r.ingredients && r.ingredients.some(i => i.toLowerCase().includes(s))));
    }).sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
  }, [activeTab, myRecipes, publicRecipes, selectedFilter, searchTerm]);

  // --- ACTIONS ---
  const handleUpload = async (e) => {
    const file = e.target.files[0];
    if (!file || !user || !db) return;
    setIsAnalyzing(true);
    setStatus({ msg: "Ladataan...", type: "info" });
    try {
      const reader = new FileReader();
      const base64 = await new Promise((res) => { reader.onload = () => res(reader.result.split(',')[1]); reader.readAsDataURL(file); });
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: "Lue resepti. JSON: { \"title\": \"\", \"category\": \"pääruoka/jälkiruoka/leivonta/aamiainen/kasvisruoka/juomat/muut\", \"ingredients\": [], \"instructions\": \"\" }. Suomeksi." }, { inlineData: { mimeType: file.type, data: base64 } }] }] })
      });
      const data = await response.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
      const jsonStart = text.indexOf('{');
      const jsonEnd = text.lastIndexOf('}') + 1;
      const recipe = JSON.parse(text.slice(jsonStart, jsonEnd));
      let cat = recipe.category?.toLowerCase().trim() || "muut";
      if (!VALID_CATEGORY_IDS.includes(cat)) cat = VALID_CATEGORY_IDS.find(id => cat.includes(id)) || "muut";
      await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'recipes'), { ...recipe, category: cat, ownerId: user.uid, createdAt: serverTimestamp(), sharedId: null, foodImage: null });
      setStatus({ msg: "Tallennettu!", type: "success" });
    } catch (err) { setStatus({ msg: "Virhe.", type: "error" }); }
    finally { setIsAnalyzing(false); e.target.value = ''; }
  };

  const startEdit = (recipe) => {
    if (!recipe) return;
    setEditForm({
      ...recipe,
      ingredients: Array.isArray(recipe.ingredients) ? recipe.ingredients.join('\n') : (recipe.ingredients || "")
    });
    setIsEditing(true);
  };

  const shareRecipe = async () => {
    if (!user || !activeRecipe || activeRecipe.sharedId || !db) return;
    setStatus({ msg: "Jaetaan...", type: "info" });
    try {
      const pubRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'recipes'), {
        title: activeRecipe.title,
        category: activeRecipe.category,
        ingredients: activeRecipe.ingredients,
        instructions: activeRecipe.instructions,
        foodImage: activeRecipe.foodImage || null,
        ownerId: user.uid,
        sourceId: activeRecipe.id,
        createdAt: serverTimestamp()
      });
      await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'recipes', activeRecipe.id), { sharedId: pubRef.id });
      setStatus({ msg: "Jaettu!", type: "success" });
    } catch (e) {
      setStatus({ msg: "Jako epäonnistui.", type: "error" });
    }
  };

  const unshareRecipe = async () => {
    if (!user || !activeRecipe || !activeRecipe.sharedId || !db) return;
    setStatus({ msg: "Peruutetaan jakoa...", type: "info" });
    try {
      await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'recipes', activeRecipe.sharedId));
      await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'recipes', activeRecipe.id), { sharedId: null });
      setStatus({ msg: "Jako peruutettu!", type: "success" });
    } catch (e) {
      setStatus({ msg: "Peruutus epäonnistui.", type: "error" });
    }
  };

  const handleVersionClick = () => {
    const newCount = versionClickCount + 1;
    setVersionClickCount(newCount);
    if (newCount >= 5) {
      setShowAdminDetails(true);
      setStatus({ msg: "Ylläpitotila aktivoitu!", type: "info" });
      setVersionClickCount(0);
    }
  };

  if (!appReady) return <div className="min-h-screen flex items-center justify-center bg-white"><Icons.Loader /></div>;

  return (
    <div className="flex flex-col min-h-screen bg-slate-50 text-slate-900 font-sans selection:bg-orange-100 pb-safe">
      
      {/* HEADER */}
      <header className="bg-white border-b pt-12 pb-6 px-4 flex flex-col items-center gap-6 shadow-sm sticky top-0 z-30">
        <div className="flex items-center gap-2">
          <h1 className="text-3xl font-black text-slate-800 uppercase tracking-tight">Reseptiarkisto</h1>
          {isAdmin && <span className="text-green-600 animate-pulse"><Icons.Shield /></span>}
        </div>
        
        <div className="flex bg-slate-100 p-1.5 rounded-2xl w-full max-w-sm border border-slate-200">
          <button onClick={() => {setActiveTab('private'); setActiveRecipe(null);}} className={`flex-1 py-2 text-[10px] font-black uppercase rounded-xl transition-all ${activeTab === 'private' ? 'bg-white shadow text-orange-600' : 'text-slate-400'}`}>Omat</button>
          <button onClick={() => {setActiveTab('public'); setActiveRecipe(null);}} className={`flex-1 py-2 text-[10px] font-black uppercase rounded-xl transition-all ${activeTab === 'public' ? 'bg-white shadow text-orange-600' : 'text-slate-400'}`}>Yhteisö</button>
          <button onClick={() => {setActiveTab('settings'); setActiveRecipe(null);}} className={`flex-1 py-2 text-[10px] font-black uppercase rounded-xl transition-all flex items-center justify-center gap-1 ${activeTab === 'settings' ? 'bg-white shadow text-orange-600' : 'text-slate-400'}`}>
            <Icons.Settings /> Asetukset
          </button>
        </div>

        {activeTab === 'private' && (
          <label className={`w-full max-w-sm flex items-center justify-center gap-3 py-4 bg-orange-600 hover:bg-orange-700 text-white rounded-2xl font-black uppercase text-sm transition-all cursor-pointer shadow-lg active:scale-95 ${isAnalyzing ? 'opacity-50 pointer-events-none' : ''}`}>
            {isAnalyzing ? <Icons.Loader /> : <Icons.Plus />}
            <span>{isAnalyzing ? 'Käsitellään...' : 'Lataa uusi resepti'}</span>
            <input type="file" className="hidden" accept="image/*" onChange={handleUpload} disabled={isAnalyzing} />
          </label>
        )}

        {activeTab !== 'settings' && (
          <div className="w-full max-w-md relative px-4">
            <div className="absolute left-8 top-1/2 -translate-y-1/2 text-slate-400"><Icons.Search /></div>
            <input type="text" placeholder="Hae arkistosta..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full pl-12 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-2xl text-sm outline-none transition-all shadow-inner" />
          </div>
        )}
      </header>

      {/* CATEGORIES */}
      {activeTab !== 'settings' && (
        <div className="bg-white border-b sticky top-[240px] md:top-[220px] z-20 overflow-x-auto no-scrollbar shadow-sm">
          <div className="max-w-5xl mx-auto px-4 py-3 flex gap-2 min-w-max md:justify-center">
            {CATEGORIES.map(cat => (
              <button key={cat.id} onClick={() => setSelectedFilter(cat.id)} className={`px-4 py-1.5 rounded-xl text-[10px] font-bold uppercase border transition-all ${selectedFilter === cat.id ? `${cat.color} text-white border-transparent shadow-sm` : 'bg-white text-slate-400 border-slate-200 hover:border-slate-300'}`}>{cat.label}</button>
            ))}
          </div>
        </div>
      )}

      {/* MAIN CONTENT */}
      <main className="flex-grow max-w-6xl mx-auto p-4 md:p-8 w-full">
        {status.msg && (
          <div className={`mb-6 p-4 rounded-2xl text-center text-[10px] font-black uppercase tracking-widest animate-in fade-in zoom-in-95 duration-300 shadow-lg ${status.type === 'error' ? 'bg-red-500 text-white' : 'bg-slate-800 text-white'}`}>
            {status.msg}
          </div>
        )}

        {activeTab === 'settings' ? (
          <div className="max-w-xl mx-auto space-y-8 animate-in slide-in-from-bottom-4">
            <div className="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm space-y-6">
              <h3 className="text-xl font-black uppercase tracking-tight text-slate-800 border-b pb-4">Varmuuskopiointi</h3>
              <p className="text-xs text-slate-400 font-medium">Voit ladata omat reseptisi JSON-tiedostona ja palauttaa ne millä tahansa laitteella.</p>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <button onClick={() => {
                   const blob = new Blob([JSON.stringify(myRecipes, null, 2)], { type: 'application/json' });
                   const url = URL.createObjectURL(blob);
                   const a = document.createElement('a'); a.href = url; a.download = `arkisto_varmuuskopio.json`; a.click();
                   setStatus({ msg: "Lataus valmis!", type: "success" });
                }} className="flex items-center justify-center gap-3 py-4 bg-slate-900 text-white rounded-2xl text-[10px] font-black uppercase shadow-lg active:scale-95">
                  <Icons.Download /> Lataa tiedosto
                </button>
                <label className="flex items-center justify-center gap-3 py-4 bg-white border-2 border-slate-100 text-slate-600 rounded-2xl text-[10px] font-black uppercase cursor-pointer hover:border-orange-200 transition-all">
                  <Icons.Upload /> Palauta tiedosto
                  <input type="file" className="hidden" accept=".json" onChange={async (e) => {
                    const file = e.target.files[0]; if (!file) return;
                    const reader = new FileReader(); reader.onload = async (ev) => {
                      try {
                        const data = JSON.parse(ev.target.result);
                        for (const r of data) {
                          const { id, createdAt, isOwner, sharedId, ...clean } = r;
                          await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'recipes'), { 
                            ...clean, 
                            sharedId: null, 
                            ownerId: user.uid, 
                            createdAt: serverTimestamp() 
                          });
                        }
                        setStatus({ msg: "Palautus onnistui!", type: "success" });
                      } catch (err) { setStatus({ msg: "Virhe.", type: "error" }); }
                    }; reader.readAsText(file);
                  }} />
                </label>
              </div>
            </div>

            {showAdminDetails && (
              <div className="bg-white p-8 rounded-[2.5rem] border border-orange-100 shadow-sm space-y-6 animate-in zoom-in-95">
                <h3 className="text-xl font-black uppercase tracking-tight text-orange-600 border-b pb-4">Ylläpitäjän asetukset</h3>
                <div className="space-y-4">
                  <div className="space-y-1">
                    <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Pääavain</label>
                    <input type="password" value={adminInput} onChange={(e) => setAdminInput(e.target.value)} className="w-full px-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl text-sm outline-none focus:ring-1 focus:ring-orange-500" placeholder="Syötä avain..." />
                  </div>
                  
                  {isAdmin && (
                    <div className="space-y-1 pt-2 border-t border-orange-50 mt-4">
                      <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Branding (Copyright)</label>
                      <input type="text" value={brandingInput} onChange={(e) => setBrandingInput(e.target.value)} className="w-full px-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl text-sm outline-none focus:ring-1 focus:ring-orange-500 mb-2" placeholder="Copyright 2026..." />
                      <button onClick={async () => {
                        if (!db) return;
                        const brandingRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'branding');
                        await setDoc(brandingRef, { copyright: brandingInput });
                        setStatus({ msg: "Copyright päivitetty pilveen!", type: "success" });
                      }} className="w-full bg-slate-800 text-white py-2 rounded-xl text-[9px] font-black uppercase shadow active:scale-95">Päivitä teksti pilveen</button>
                    </div>
                  )}

                  <button onClick={async () => {
                     if (!db || !adminInput) return;
                     const adminRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'admin');
                     const docSnap = await getDoc(adminRef);
                     if (!docSnap.exists()) {
                       await setDoc(adminRef, { uids: [user.uid], masterKey: adminInput, createdAt: serverTimestamp() });
                       setStatus({ msg: "Admin luotu!", type: "success" });
                     } else if (docSnap.data().masterKey === adminInput) {
                       await updateDoc(adminRef, { uids: arrayUnion(user.uid) });
                       setStatus({ msg: "Laite vahvistettu!", type: "success" });
                     } else {
                       setStatus({ msg: "Väärä avain.", type: "error" });
                     }
                     if (!isAdmin) setShowAdminDetails(false);
                  }} className="w-full bg-orange-600 text-white py-4 rounded-2xl text-[10px] font-black uppercase shadow-lg active:scale-95">Synkronoi laite</button>
                </div>
              </div>
            )}
          </div>
        ) : (
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 animate-in fade-in">
            {filteredRecipes.map(r => (
              <div key={r.id} onClick={() => { setActiveRecipe(r); setIsEditing(false); }} className="bg-white rounded-[2rem] p-4 border-2 border-transparent hover:border-orange-500 transition-all cursor-pointer shadow-sm flex flex-col gap-4 group">
                <div className="h-44 w-full bg-slate-100 rounded-[1.5rem] overflow-hidden relative border border-slate-50">
                  {r.foodImage ? <img src={r.foodImage} alt={r.title} className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" /> : <div className="w-full h-full flex items-center justify-center opacity-30"><Icons.Image /></div>}
                  <div className="absolute top-3 left-3 flex gap-1">
                     <span className={`px-2 py-0.5 rounded text-[8px] font-black uppercase text-white shadow-sm ${CATEGORIES.find(c => c.id === r.category?.toLowerCase())?.color || 'bg-slate-400'}`}>{r.category}</span>
                     {activeTab === 'private' && r.sharedId && <span className="bg-green-600 text-white px-2 py-0.5 rounded text-[7px] font-bold uppercase flex items-center gap-1 shadow-sm"><Icons.Check /> Jaettu</span>}
                  </div>
                </div>
                <div className="px-2 space-y-3">
                  <h3 className="font-bold text-xl text-slate-800 line-clamp-1 group-hover:text-orange-600 transition-colors">{r.title}</h3>
                  <div className="flex justify-between items-center border-t border-slate-50 pt-2">
                    <span className="text-[10px] font-bold text-slate-300 uppercase tracking-tight">{r.ingredients?.length || 0} osaa</span>
                    {(r.isOwner || isAdmin) && <button onClick={e => { e.stopPropagation(); setRecipeToDelete(r.id); }} className="text-slate-200 hover:text-red-500 p-2 transition-colors"><Icons.Trash /></button>}
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </main>

      {/* DETAIL MODAL */}
      {activeRecipe && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-md">
          <div className="bg-white w-full max-w-5xl max-h-[95vh] rounded-[2.5rem] overflow-hidden flex flex-col shadow-2xl animate-in zoom-in-95">
            <div className="p-4 border-b flex justify-between items-center bg-slate-50/50">
              <span className="text-[10px] font-black uppercase text-slate-400 ml-4">{isEditing ? 'Muokkaus' : 'Resepti'}</span>
              <button onClick={() => { setActiveRecipe(null); setIsEditing(false); }} className="p-2 text-slate-300 hover:text-slate-900 mr-2 transition-colors"><Icons.X /></button>
            </div>
            
            <div className="overflow-y-auto p-6 md:p-12 custom-scrollbar">
              {isEditing && editForm ? (
                <div className="space-y-8 animate-in fade-in">
                  <div className="space-y-2">
                    <label className="text-[9px] font-black text-slate-400 uppercase ml-1">Otsikko</label>
                    <input type="text" value={editForm.title} onChange={e => setEditForm({...editForm, title: e.target.value})} className="w-full text-3xl md:text-5xl font-black border-b-4 border-orange-100 outline-none pb-2 bg-transparent focus:border-orange-500 transition-all tracking-tighter" />
                  </div>
                  <div className="grid md:grid-cols-12 gap-10">
                    <div className="md:col-span-5 space-y-6">
                      <label className="block h-64 w-full bg-slate-50 rounded-[2rem] border-2 border-dashed border-slate-200 hover:border-orange-300 transition-all cursor-pointer overflow-hidden relative">
                        {editForm.foodImage ? <img src={editForm.foodImage} className="w-full h-full object-cover" /> : <div className="w-full h-full flex flex-col items-center justify-center text-slate-400 gap-2"><Icons.Camera /><span className="text-[9px] font-bold uppercase tracking-tight">Vaihda kuva</span></div>}
                        <input type="file" className="hidden" accept="image/*" onChange={async (e) => {
                          const file = e.target.files[0]; if (!file) return;
                          const reader = new FileReader(); reader.readAsDataURL(file);
                          reader.onload = (ev) => {
                            const img = new Image(); img.src = ev.target.result;
                            img.onload = () => {
                              const canvas = document.createElement('canvas'); const MAX_WIDTH = 800; const scale = MAX_WIDTH / img.width;
                              canvas.width = MAX_WIDTH; canvas.height = img.height * scale;
                              const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                              setEditForm({ ...editForm, foodImage: canvas.toDataURL('image/jpeg', 0.7) });
                            };
                          };
                        }} />
                      </label>
                      <select value={editForm.category} onChange={e => setEditForm({...editForm, category: e.target.value})} className="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl text-sm font-bold">
                        {VALID_CATEGORY_IDS.map(id => (<option key={id} value={id}>{id.charAt(0).toUpperCase() + id.slice(1)}</option>))}
                      </select>
                    </div>
                    <div className="md:col-span-7 space-y-6">
                      <textarea value={editForm.ingredients} onChange={e => setEditForm({...editForm, ingredients: e.target.value})} className="w-full p-6 bg-slate-50 rounded-[1.5rem] h-48 text-sm font-bold border-none outline-none focus:ring-2 focus:ring-orange-100" placeholder="Ainekset..." />
                      <textarea value={editForm.instructions} onChange={e => setEditForm({...editForm, instructions: e.target.value})} className="w-full p-6 bg-slate-900 text-white rounded-[2rem] h-64 text-sm font-medium border-none outline-none focus:ring-2 focus:ring-orange-500" placeholder="Ohje..." />
                    </div>
                  </div>
                  <button onClick={async () => {
                    const path = activeTab === 'private' ? ['artifacts', appId, 'users', user.uid, 'recipes', activeRecipe.id] : ['artifacts', appId, 'public', 'data', 'recipes', activeRecipe.id];
                    await updateDoc(doc(db, ...path), { title: editForm.title, category: editForm.category, ingredients: editForm.ingredients.split('\n').filter(i => i.trim()), instructions: editForm.instructions, foodImage: editForm.foodImage || null });
                    setIsEditing(false); setActiveRecipe(null);
                    setStatus({ msg: "Muutokset tallennettu!", type: "success" });
                  }} className="w-full py-5 bg-green-600 text-white rounded-2xl font-black uppercase text-xs shadow-xl active:scale-95 transition-all">Tallenna muutokset</button>
                </div>
              ) : (
                <div className="space-y-8">
                  <h2 className="text-4xl md:text-6xl font-black text-slate-900 tracking-tighter leading-[0.9]">{activeRecipe.title}</h2>
                  <div className="grid md:grid-cols-12 gap-10">
                    <div className="md:col-span-5 space-y-8">
                       <div className="h-64 md:h-80 w-full bg-slate-100 rounded-[2.5rem] overflow-hidden shadow-inner border border-slate-50">
                         {activeRecipe.foodImage ? <img src={activeRecipe.foodImage} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center opacity-30 scale-150"><Icons.Image /></div>}
                       </div>
                       <div className="space-y-4">
                          <h4 className="text-[10px] font-black uppercase text-orange-600 tracking-widest border-b border-orange-100 pb-2">Ainekset</h4>
                          <div className="space-y-2">
                            {activeRecipe.ingredients?.map((ing, i) => (
                              <div key={i} className="p-4 bg-slate-50 rounded-2xl text-sm font-bold text-slate-700 border border-slate-100 flex items-center gap-3"><div className="w-1.5 h-1.5 bg-orange-500 rounded-full" />{ing}</div>
                            ))}
                          </div>
                       </div>
                    </div>
                    <div className="md:col-span-7 space-y-8">
                       <div className="space-y-4">
                          <h4 className="text-[10px] font-black uppercase text-orange-600 tracking-widest border-b border-orange-100 pb-2">Valmistusohje</h4>
                          <div className="bg-slate-900 text-slate-50 p-8 rounded-[2.5rem] text-lg leading-relaxed whitespace-pre-wrap font-medium shadow-2xl relative overflow-hidden">
                            {activeRecipe.instructions}
                          </div>
                       </div>

                       {activeRecipe.isOwner && (
                        <div className="flex flex-wrap gap-3 pt-4">
                          {activeRecipe.sharedId ? (
                            <button onClick={unshareRecipe} className="flex-1 min-w-[140px] flex items-center justify-center gap-2 py-4 bg-red-50 text-red-600 border-2 border-red-100 rounded-2xl text-[10px] font-black uppercase hover:bg-red-100 transition-all active:scale-95 shadow-sm">
                              Peruuta jako
                            </button>
                          ) : (
                            <button onClick={shareRecipe} className="flex-1 min-w-[140px] flex items-center justify-center gap-2 py-4 bg-orange-50 text-orange-600 border-2 border-orange-200 rounded-2xl text-[10px] font-black uppercase hover:bg-orange-100 transition-all active:scale-95 shadow-sm">
                              <Icons.Share /> Jaa yhteisölle
                            </button>
                          )}
                          <button onClick={() => startEdit(activeRecipe)} className="flex-1 min-w-[140px] flex items-center justify-center gap-2 py-4 bg-slate-900 text-white rounded-2xl text-[10px] font-black uppercase shadow-lg active:scale-95 transition-all"><Icons.Edit /> Muokkaa</button>
                        </div>
                       )}
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* DELETE MODAL */}
      {recipeToDelete && (
        <div className="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
          <div className="bg-white p-8 rounded-[2.5rem] shadow-2xl max-w-xs w-full text-center space-y-6 animate-in zoom-in-95">
             <h3 className="text-xl font-black uppercase tracking-tight">Poistetaanko?</h3>
             <div className="flex flex-col gap-2">
               <button onClick={async () => {
                 const path = activeTab === 'private' ? ['artifacts', appId, 'users', user.uid, 'recipes', recipeToDelete] : ['artifacts', appId, 'public', 'data', 'recipes', recipeToDelete];
                 await deleteDoc(doc(db, ...path)); setRecipeToDelete(null); if (activeRecipe?.id === recipeToDelete) setActiveRecipe(null);
                 setStatus({ msg: "Poistettu.", type: "info" });
               }} className="w-full py-3 bg-red-600 text-white rounded-xl font-bold uppercase text-xs">Poista</button>
               <button onClick={() => setRecipeToDelete(null)} className="w-full py-3 bg-slate-100 text-slate-500 rounded-xl font-bold uppercase text-xs">Peruuta</button>
             </div>
          </div>
        </div>
      )}

      {/* FOOTER */}
      <footer className="py-12 border-t bg-white flex flex-col items-center gap-2 text-center mb-safe">
        <p className="text-slate-500 font-bold text-sm tracking-tight">
          {branding?.copyright || "Copyright 2026 Pekka Niemistö"}
        </p>
        <button 
          onClick={handleVersionClick}
          className="text-slate-200 font-medium text-[8px] uppercase tracking-[0.3em] hover:text-orange-400 transition-colors"
        >
          Versio 1.6.5-stable + PWA
        </button>
      </footer>

      <style>{`
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .mb-safe { margin-bottom: env(safe-area-inset-bottom); }
      `}</style>
    </div>
  );
}
